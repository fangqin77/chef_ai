<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.chef_ai_backend.mapper.NotificationMapper">

  <!-- 我的帖子被评论的通知列表（含评论者昵称/头像、帖子简要） -->
  <select id="listUserPostCommentNotifications" resultType="map">
    SELECT 
      c.id               AS comment_id,
      c.post_id          AS post_id,
      c.user_id          AS commenter_id,
      c.content          AS comment_content,
      c.created_at       AS comment_created_at,
      p.content          AS post_content,
      p.audit_status     AS post_audit_status,
      p.status           AS post_status,
      u.nickname         AS commenter_nickname,
      u.avatar_url       AS commenter_avatar_url
    FROM comments c
    JOIN posts p ON p.id = c.post_id
    LEFT JOIN userss u ON u.id = c.user_id
    WHERE p.user_id = #{userId}
      AND c.status = 'normal'
      AND p.status = 'normal'
      AND p.audit_status = 'approved'
    ORDER BY c.id DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="countUserPostCommentNotifications" resultType="int">
    SELECT COUNT(1)
    FROM comments c
    JOIN posts p ON p.id = c.post_id
    WHERE p.user_id = #{userId}
      AND c.status = 'normal'
      AND p.status = 'normal'
      AND p.audit_status = 'approved'
  </select>

</mapper>
