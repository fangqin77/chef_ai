<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.chef_ai_backend.mapper.CommunityMapper">

  <resultMap id="PostMap" type="com.example.chef_ai_backend.model.Post">
    <id property="id" column="id"/>
    <result property="userId" column="user_id"/>
    <result property="content" column="content"/>
    <result property="mediaJson" column="media_json"/>
    <result property="visibility" column="visibility"/>
    <result property="status" column="status"/>
    <result property="auditStatus" column="audit_status"/>
    <result property="likeCount" column="like_count"/>
    <result property="commentCount" column="comment_count"/>
    <result property="createdAt" column="created_at"/>
    <result property="updatedAt" column="updated_at"/>
  </resultMap>

  <resultMap id="CommentMap" type="com.example.chef_ai_backend.model.Comment">
    <id property="id" column="id"/>
    <result property="postId" column="post_id"/>
    <result property="userId" column="user_id"/>
    <result property="parentId" column="parent_id"/>
    <result property="content" column="content"/>
    <result property="status" column="status"/>
    <result property="auditStatus" column="audit_status"/>
    <result property="likeCount" column="like_count"/>
    <result property="createdAt" column="created_at"/>
  </resultMap>

  <!-- 列表：仅展示审核通过且正常的帖子 -->
  <select id="listApprovedPosts" resultMap="PostMap">
    SELECT * FROM posts
    WHERE audit_status = 'approved' AND status = 'normal'
    <if test="keyword != null and keyword != ''">
      AND content LIKE CONCAT('%', #{keyword}, '%')
    </if>
    <if test="userId != null">
      AND user_id = #{userId}
    </if>
    ORDER BY id DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="countApprovedPosts" resultType="int">
    SELECT COUNT(1) FROM posts
    WHERE audit_status = 'approved' AND status = 'normal'
    <if test="keyword != null and keyword != ''">
      AND content LIKE CONCAT('%', #{keyword}, '%')
    </if>
    <if test="userId != null">
      AND user_id = #{userId}
    </if>
  </select>

  <!-- 本人帖子（含待审/驳回） -->
  <select id="listMyPosts" resultMap="PostMap">
    SELECT * FROM posts
    WHERE user_id = #{ownerId}
    ORDER BY id DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>
  <select id="countMyPosts" resultType="int">
    SELECT COUNT(1) FROM posts WHERE user_id = #{ownerId}
  </select>

  <!-- 详情：非作者只能看 approved+normal；作者可见自己的任何状态 -->
  <select id="getPostForViewer" resultMap="PostMap">
    SELECT p.* FROM posts p
    WHERE p.id = #{postId}
      AND (
        p.user_id = #{viewerId}
        OR (p.audit_status = 'approved' AND p.status = 'normal')
      )
    LIMIT 1
  </select>

  <insert id="insertPost" parameterType="com.example.chef_ai_backend.model.Post" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO posts (user_id, content, media_json, visibility, status, audit_status)
    VALUES (#{userId}, #{content}, #{mediaJson}, #{visibility}, 'normal', 'approved')
  </insert>

  <!-- 管理端：分页查询帖子（任意状态） -->
  <select id="listAdminPosts" resultMap="PostMap">
    SELECT * FROM posts
    WHERE 1=1
    <if test="keyword != null and keyword != ''">
      AND content LIKE CONCAT('%', #{keyword}, '%')
    </if>
    <if test="auditStatus != null and auditStatus != '' and auditStatus != 'all'">
      AND audit_status = #{auditStatus}
    </if>
    <if test="status != null and status != '' and status != 'all'">
      AND status = #{status}
    </if>
    <if test="userId != null">
      AND user_id = #{userId}
    </if>
    ORDER BY p.id DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <!-- 管理端帖子视图：联表用户昵称（Map） -->
  <select id="listAdminPostsView" resultType="map">
    SELECT p.*, u.nickname AS user_nickname
    FROM posts p
    LEFT JOIN userss u ON u.id = p.user_id
    WHERE 1=1
    <if test="keyword != null and keyword != ''">
      AND p.content LIKE CONCAT('%', #{keyword}, '%')
    </if>
    <if test="auditStatus != null and auditStatus != '' and auditStatus != 'all'">
      AND p.audit_status = #{auditStatus}
    </if>
    <if test="status != null and status != '' and status != 'all'">
      AND p.status = #{status}
    </if>
    <if test="userId != null">
      AND p.user_id = #{userId}
    </if>
    ORDER BY p.id DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="countAdminPosts" resultType="int">
    SELECT COUNT(1) FROM posts
    WHERE 1=1
    <if test="keyword != null and keyword != ''">
      AND content LIKE CONCAT('%', #{keyword}, '%')
    </if>
    <if test="auditStatus != null and auditStatus != '' and auditStatus != 'all'">
      AND audit_status = #{auditStatus}
    </if>
    <if test="status != null and status != '' and status != 'all'">
      AND status = #{status}
    </if>
    <if test="userId != null">
      AND user_id = #{userId}
    </if>
  </select>

  <select id="getPostById" resultMap="PostMap">
    SELECT * FROM posts WHERE id = #{postId} LIMIT 1
  </select>

  <update id="updatePostAuditStatus">
    UPDATE posts SET audit_status = #{toStatus}
    WHERE id = #{postId}
    <if test="fromStatus != null and fromStatus != ''">
      AND audit_status = #{fromStatus}
    </if>
  </update>

  <!-- 管理端：评论分页查询 -->
  <select id="listAdminComments" resultMap="CommentMap">
    SELECT * FROM comments
    WHERE 1=1
  </select>

  <!-- 管理端评论视图：联表用户昵称、保留帖子ID -->
  <select id="listAdminCommentsView" resultType="map">
    SELECT c.*, u.nickname AS user_nickname
    FROM comments c
    LEFT JOIN userss u ON u.id = c.user_id
    WHERE 1=1
    <if test="postId != null">AND post_id = #{postId}</if>
    <if test="keyword != null and keyword != ''">AND content LIKE CONCAT('%', #{keyword}, '%')</if>
    <if test="auditStatus != null and auditStatus != '' and auditStatus != 'all'">AND audit_status = #{auditStatus}</if>
    <if test="status != null and status != '' and status != 'all'">AND status = #{status}</if>
    ORDER BY c.id DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>
  <select id="countAdminComments" resultType="int">
    SELECT COUNT(1) FROM comments
    WHERE 1=1
    <if test="postId != null">AND post_id = #{postId}</if>
    <if test="keyword != null and keyword != ''">AND content LIKE CONCAT('%', #{keyword}, '%')</if>
    <if test="auditStatus != null and auditStatus != '' and auditStatus != 'all'">AND audit_status = #{auditStatus}</if>
    <if test="status != null and status != '' and status != 'all'">AND status = #{status}</if>
  </select>
  <update id="updateCommentAuditStatus">
    UPDATE comments SET audit_status = #{toStatus}
    WHERE id = #{commentId}
    <if test="fromStatus != null and fromStatus != ''">
      AND audit_status = #{fromStatus}
    </if>
  </update>

  <!-- 管理端：举报分页查询与状态更新 -->
  <select id="listAdminReports" resultType="map">
    SELECT id, target_type, target_id, reporter_id, reason_code, text, status, created_at FROM reports
    WHERE 1=1
    <if test="targetType != null and targetType != '' and targetType != 'all'">AND target_type = #{targetType}</if>
    <if test="status != null and status != '' and status != 'all'">AND status = #{status}</if>
    ORDER BY id DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>
  <select id="countAdminReports" resultType="int">
    SELECT COUNT(1) FROM reports
    WHERE 1=1
    <if test="targetType != null and targetType != '' and targetType != 'all'">AND target_type = #{targetType}</if>
    <if test="status != null and status != '' and status != 'all'">AND status = #{status}</if>
  </select>
  <update id="updateReportStatus">
    UPDATE reports SET status = #{toStatus} WHERE id = #{reportId}
  </update>

  <update id="softDeletePost">
    UPDATE posts
    SET status = 'deleted'
    WHERE id = #{postId} AND user_id = #{ownerId} AND status = 'normal'
  </update>

  <!-- 编辑帖子（仅作者） -->
  <update id="updatePost">
    UPDATE posts
    SET 
      content = #{content},
      media_json = #{mediaJson},
      visibility = #{visibility},
      updated_at = NOW()
    WHERE id = #{postId} AND user_id = #{ownerId} AND status = 'normal'
  </update>

  <!-- 收藏的帖子列表：仅展示正常+已审核 -->
  <select id="listFavoritePosts" resultMap="PostMap">
    SELECT p.*
    FROM posts p
    JOIN favorites f ON f.post_id = p.id
    WHERE f.user_id = #{userId}
      AND p.status = 'normal' AND p.audit_status = 'approved'
    ORDER BY p.id DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>
  <select id="countFavoritePosts" resultType="int">
    SELECT COUNT(1)
    FROM posts p
    JOIN favorites f ON f.post_id = p.id
    WHERE f.user_id = #{userId}
      AND p.status = 'normal' AND p.audit_status = 'approved'
  </select>

  <!-- 我发表的评论列表（正常） -->
  <select id="listMyComments" resultMap="CommentMap">
    SELECT * FROM comments
    WHERE user_id = #{userId} AND status = 'normal'
    ORDER BY id DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>
  <select id="countMyComments" resultType="int">
    SELECT COUNT(1) FROM comments
    WHERE user_id = #{userId} AND status = 'normal'
  </select>

  <!-- 评论：仅展示通过+正常；parentId 为空查一级 -->
  <select id="listApprovedComments" resultMap="CommentMap">
    SELECT * FROM comments
    WHERE post_id = #{postId}
      AND audit_status = 'approved' AND status = 'normal'
    <if test="parentId == null">
      AND parent_id IS NULL
    </if>
    <if test="parentId != null">
      AND parent_id = #{parentId}
    </if>
    ORDER BY id ASC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="countApprovedComments" resultType="int">
    SELECT COUNT(1) FROM comments
    WHERE post_id = #{postId}
      AND audit_status = 'approved' AND status = 'normal'
    <if test="parentId == null">
      AND parent_id IS NULL
    </if>
    <if test="parentId != null">
      AND parent_id = #{parentId}
    </if>
  </select>

  <insert id="insertComment" parameterType="com.example.chef_ai_backend.model.Comment" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO comments (post_id, user_id, parent_id, content, status, audit_status)
    VALUES (#{postId}, #{userId}, #{parentId}, #{content}, 'normal', 'pending')
  </insert>

  <update id="softDeleteComment">
    UPDATE comments
    SET status = 'deleted'
    WHERE id = #{commentId} AND user_id = #{ownerId} AND status = 'normal'
  </update>

  <!-- 点赞/收藏：幂等（唯一索引） -->
  <insert id="insertPostLike">
    INSERT IGNORE INTO post_likes (post_id, user_id) VALUES (#{postId}, #{userId})
  </insert>
  <delete id="deletePostLike">
    DELETE FROM post_likes WHERE post_id = #{postId} AND user_id = #{userId}
  </delete>
  <insert id="insertFavorite">
    INSERT IGNORE INTO favorites (post_id, user_id) VALUES (#{postId}, #{userId})
  </insert>
  <delete id="deleteFavorite">
    DELETE FROM favorites WHERE post_id = #{postId} AND user_id = #{userId}
  </delete>

  <!-- 计数：按增量更新 -->
  <update id="incrPostLikeCount">
    UPDATE posts SET like_count = like_count + #{delta} WHERE id = #{postId}
  </update>
  <update id="incrPostCommentCount">
    UPDATE posts SET comment_count = comment_count + #{delta} WHERE id = #{postId}
  </update>

  <!-- 举报 -->
  <insert id="insertReport">
    INSERT INTO reports (target_type, target_id, reporter_id, reason_code, text, status)
    VALUES (#{targetType}, #{targetId}, #{reporterId}, #{reasonCode}, #{text}, 'pending')
  </insert>
</mapper>