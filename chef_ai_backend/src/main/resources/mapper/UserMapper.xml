<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.chef_ai_backend.mapper.UserMapper">
  <resultMap id="UserMap" type="com.example.chef_ai_backend.model.User">
    <id property="id" column="id"/>
    <result property="openid" column="openid"/>
    <result property="sessionKey" column="session_key"/>
    <result property="token" column="token"/>
    <result property="tokenExpireAt" column="token_expire_at"/>
    <result property="unionid" column="unionid"/>
    <result property="nickname" column="nickname"/>
    <result property="avatarUrl" column="avatar_url"/>
    <result property="description" column="description"/>
    <result property="gender" column="gender"/>
    <result property="phone" column="phone"/>
    <result property="province" column="province"/>
    <result property="city" column="city"/>
    <result property="country" column="country"/>
    <result property="status" column="status"/>
    <result property="lastLoginAt" column="last_login_at"/>
    <result property="loginCount" column="login_count"/>
    <result property="createdAt" column="created_at"/>
    <result property="updatedAt" column="updated_at"/>
  </resultMap>

  <!-- 推荐作者：按粉丝数、获赞数倒序 -->
  <select id="selectRecommended" resultMap="UserMap">
    SELECT *
    FROM `userss`
    ORDER BY created_at DESC
    LIMIT #{limit}
  </select>
  
  <!-- 根据openid查询用户 -->
  <select id="selectByOpenid" resultMap="UserMap" parameterType="string">
    SELECT * FROM `userss` WHERE openid = #{openid}
  </select>
  
  <!-- 更新用户信息 -->
  <update id="updateById" parameterType="com.example.chef_ai_backend.model.User">
    UPDATE `userss`
    SET nickname = #{nickname},
        session_key = #{sessionKey},
        avatar_url = #{avatarUrl},
        gender = #{gender},
        phone = #{phone},
        province = #{province},
        city = #{city},
        country = #{country},
        updated_at = NOW()
    WHERE id = #{id}
  </update>
  
  <!-- 插入新用户 -->
  <insert id="insert" parameterType="com.example.chef_ai_backend.model.User" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO `userss` (openid, session_key, token, token_expire_at, unionid, nickname, avatar_url, gender, phone, province, city, country, status, last_login_at, login_count, created_at, updated_at)
    VALUES (#{openid}, #{sessionKey}, #{token}, #{tokenExpireAt}, #{unionid}, #{nickname}, #{avatarUrl}, #{gender}, #{phone}, #{province}, #{city}, #{country}, #{status}, #{lastLoginAt}, #{loginCount}, #{createdAt}, #{updatedAt})
  </insert>
  
  <!-- 根据ID查询 -->
  <select id="selectById" parameterType="long" resultMap="UserMap">
    SELECT * FROM `userss` WHERE id = #{id}
  </select>

  <!-- 新增：查询用户简介（昵称、头像、简介） -->
  <select id="selectUserIntroduction" parameterType="long" resultMap="UserMap">
    SELECT id, nickname, avatar_url, description FROM `userss` WHERE id = #{userId}
  </select>

  <!-- 统计该用户所有帖子获赞总数 -->
  <select id="sumUserPostLikes" parameterType="long" resultType="int">
    SELECT COALESCE(SUM(p.like_count), 0)
    FROM posts p
    WHERE p.user_id = #{userId}
  </select>

  <!-- 统计该用户帖子被收藏的用户数（去重） -->
  <select id="countUserPostFans" parameterType="long" resultType="int">
    SELECT COALESCE(COUNT(DISTINCT f.user_id), 0)
    FROM favorites f
    JOIN posts p ON p.id = f.post_id
    WHERE p.user_id = #{userId}
  </select>

  <!-- 动态选择性更新（只更新非空字段） -->
  <update id="updateSelective" parameterType="com.example.chef_ai_backend.model.User">
    UPDATE `userss`
    <set>
      <if test="nickname != null">nickname = #{nickname},</if>
      <if test="sessionKey != null">session_key = #{sessionKey},</if>
      <if test="avatarUrl != null">avatar_url = #{avatarUrl},</if>
      <if test="description != null">description = #{description},</if>
      <if test="gender != null">gender = #{gender},</if>
      <if test="phone != null">phone = #{phone},</if>
      <if test="province != null">province = #{province},</if>
      <if test="city != null">city = #{city},</if>
      <if test="country != null">country = #{country},</if>
      <if test="status != null">status = #{status},</if>
      <if test="lastLoginAt != null">last_login_at = #{lastLoginAt},</if>
      <if test="loginCount != null">login_count = #{loginCount},</if>
      updated_at = NOW()
    </set>
    WHERE id = #{id}
  </update>

  <!-- 单独更新头像 -->
  <update id="updateAvatar" parameterType="com.example.chef_ai_backend.model.User">
    UPDATE `userss`
    SET avatar_url = #{avatarUrl}, updated_at = NOW()
    WHERE id = #{id}
  </update>
</mapper>