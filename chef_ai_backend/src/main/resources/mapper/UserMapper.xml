<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.chef_ai_backend.mapper.UserMapper">
  <resultMap id="UserMap" type="com.example.chef_ai_backend.model.User">
    <id property="id" column="id"/>
    <result property="openid" column="openid"/>
    <result property="sessionKey" column="session_key"/>
    <result property="nickname" column="nickname"/>
    <result property="avatarUrl" column="avatar_url"/>
    <result property="createdAt" column="created_at"/>
    <result property="updatedAt" column="updated_at"/>
  </resultMap>

  <!-- 推荐作者：按粉丝数、获赞数倒序 -->
  <select id="selectRecommended" resultMap="UserMap">
    SELECT *
    FROM `userss`
    ORDER BY created_at DESC
    LIMIT #{limit}
  </select>
  
  <!-- 根据openid查询用户 -->
  <select id="selectByOpenid" resultMap="UserMap" parameterType="string">
    SELECT * FROM `userss` WHERE openid = #{openid}
  </select>
  
  <!-- 更新用户信息 -->
  <update id="updateById" parameterType="com.example.chef_ai_backend.model.User">
    UPDATE `userss`
    SET nickname = #{nickname},
        session_key = #{sessionKey},
        avatar_url = #{avatarUrl},
        updated_at = #{updatedAt}
    WHERE id = #{id}
  </update>
  
  <!-- 插入新用户 -->
  <insert id="insert" parameterType="com.example.chef_ai_backend.model.User" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO `userss` (openid, session_key, nickname, avatar_url, created_at, updated_at)
    VALUES (#{openid}, #{sessionKey}, #{nickname}, #{avatarUrl}, #{createdAt}, #{updatedAt})
  </insert>
  
  <!-- 根据ID查询 -->
  <select id="selectById" parameterType="long" resultMap="UserMap">
    SELECT * FROM `userss` WHERE id = #{id}
  </select>

  <!-- 动态选择性更新（只更新非空字段） -->
  <update id="updateSelective" parameterType="com.example.chef_ai_backend.model.User">
    UPDATE `userss`
    <set>
      <if test="nickname != null">nickname = #{nickname},</if>
      <if test="sessionKey != null">session_key = #{sessionKey},</if>
      <if test="avatarUrl != null">avatar_url = #{avatarUrl},</if>
      <if test="updatedAt != null">updated_at = #{updatedAt},</if>
      <!-- 如有 phone/province/city 等列，可继续加 -->
    </set>
    WHERE id = #{id}
  </update>

  <!-- 单独更新头像 -->
  <update id="updateAvatar" parameterType="com.example.chef_ai_backend.model.User">
    UPDATE `userss`
    SET avatar_url = #{avatarUrl}, updated_at = NOW()
    WHERE id = #{id}
  </update>
</mapper>